pipeline {
    agent any
    environment {
        // Set environment variables for OpenShift
        OPENSHIFT_PROJECT = "sindhupsvn13-dev"  // Set your OpenShift project name
        OPENSHIFT_URL = "https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443"  // OpenShift API URL
        OPENSHIFT_TOKEN = "sha256~_AjwPkp7mP7sYcsBmJNQglqbovH8QOGymcaZsDHsZus"  // Replace with your OpenShift access token
        DOCKER_IMAGE_NAME = "missing-number-app"  // The name of your Docker image
        DOCKER_REGISTRY = "docker.io/sindhu138"  // Your Docker registry username (Docker Hub)
    }
    stages {
        stage('Checkout') {
            steps {
                // Checkout the code from Git repository
                git url: 'https://github.com/Satyaksvn/MissingNumber', branch: 'main'
            }
        }
        stage('Build') {
            steps {
                // Build the Java application (Using Maven in this example)
                echo 'Building Java Application'
                // Ensure Maven is installed on the Jenkins environment
                sh '''#!/bin/bash
if ! command -v mvn &> /dev/null; then
    echo "Maven could not be found, please install Maven manually."
    exit 1
fi
mvn clean install
                '''
            }
        }
        stage('Docker Build & Push') {
            steps {
                // Build the Docker image and push it to a Docker registry
                echo 'Building Docker Image'
                sh '''
                docker build -t $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME .
                docker push $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME
                '''
            }
        }
        stage('Deploy to OpenShift') {
            steps {
                // Deploy the application to OpenShift
                echo 'Deploying to OpenShift'
                sh '''
                oc login https://api.sandbox-m2.ll9k.p1.openshiftapps.com:6443 --token=$OPENSHIFT_TOKEN
                oc project $OPENSHIFT_PROJECT
                oc new-app $DOCKER_REGISTRY/$DOCKER_IMAGE_NAME
                '''
            }
        }
    }
}
